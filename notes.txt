App Structure:
/
├── app/
│   ├── (admin)/                # (Grup Rute) Untuk halaman yang pakai admin layout
│   │   ├── layout.tsx          # <-- DI SINI KODE LAYOUT ANDA DITEMPATKAN
│   │   ├── page.tsx            # (Halaman Dashboard / Beranda Admin)
│   │   └── users/
│   │       └── page.tsx        # (Contoh: Halaman manajemen user)
│   │
│   ├── (auth)/                 # (Grup Rute) Untuk halaman login/register
│   │   ├── login/
│   │   │   └── page.tsx
│   │   └── layout.tsx          # (Layout simpel tanpa sidebar/header)
│   │
│   ├── layout.tsx              # (Root Layout - Server Component)
│   └── globals.css             # (File CSS global & Tailwind)
|   └── provider.tsx            # berisi ThemeProvider, NextTopProvider, dan SidebarProvider
│
├── components/
|   ├── icon/                   # berisi icon2 yang digunakan 
│   ├── layouts/
│   │   ├── header
|   |   |   │   ├── notification
|   |   |   │   ├── theme-toggle
|   |   |   │   ├── user-info
|   |   |   │   ├── icons.tsx
|   |   |   │   ├── index.tsx     # file utama header
│   │   ├── sidebar
|   |   |   │   ├── data
|   |   |   │   |    ├── index.ts # berisi list menu
|   |   |   │   ├── icons.tsx
|   |   |   │   ├── index.tsx     # file utama sidebar
|   |   |   │   ├── menu-item.tsx
|   |   |   │   ├── sidebar-context.tsx
│   ├── ui/                     # (Opsional: untuk komponen UI kecil spt Button, Input)
│   └── App.tsx                 # (Komponen <App> dari template Anda)
│
├── lib/
│   └── supabase/
│       ├── client.ts           # (Supabase client untuk Client Component)
│       └── server.ts           # (Supabase client untuk Server Component)
│
├── store/
│   ├── provider.tsx            # (Redux Provider - Client Component)
│   ├── store.ts                # (Konfigurasi Redux Store)
│   └── userSlice.ts            # (Slice Redux Anda)
│
├── proxy.ts                    # (Untuk proteksi rute / auth)
├── .env.local                  # (Menyimpan kunci API Supabase)
└── tailwind.config.js


akun: 
superadmin@pjpsuperapp.com
superadmin: pjpsuksesb4r0k4H


Mekanisme "Sync" / "Auto-Fill" laporan KBM:

Jika user mengisi Rekap Presensi, sistem otomatis meng-update (atau membuat draft) row di kbm_reports (kolom count_male/female, attendance_%).

Jika user mengisi Rekap Penilaian, sistem otomatis meng-update row di kbm_reports (kolom achievement_... atau program_success).

Jika user Manual, mereka mengedit kbm_reports secara langsung (menimpa data otomatis).



/********************************
* Struktur Database:
********************************/

Ringkasan Arsitektur
Auth: Kita gunakan tabel auth.users bawaan Supabase.
Role: Kita simpan role di auth.users.user_metadata (seperti yang kita putuskan).
Data User: Kita simpan di tabel public.profile yang terhubung 1-ke-1 dengan auth.users.
Master Data: public.village, public.class, public.group.
Otorisasi:
Level Admin (Server Actions): Ditangani oleh userService.ts (menggunakan service_role key) yang mem-bypass RLS.
Level User (Client): Ditangani oleh Row Level Security (RLS) agar user hanya bisa melihat/mengedit data mereka sendiri.

Langkah 1: Buat Tabel Master (Village, Class, Group)
Tabel ini adalah data induk yang akan direferensikan oleh profil pengguna.
-- 1. Tabel Desa (Village)
CREATE TABLE public.village (
 id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
 name text NOT NULL,
 description text,
 created_at timestamptz DEFAULT now()
);


-- 2. Tabel Kelas (Class)
CREATE TABLE public.category (
 id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
 name text NOT NULL,
 description text,
 created_at timestamptz DEFAULT now()
);


-- 3. Tabel Kelompok (Group)
CREATE TABLE public.group (
 id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
 name text NOT NULL,
 description text,
 -- Relasi ke tabel village
 village_id bigint REFERENCES public.village(id) ON DELETE SET NULL,
 created_at timestamptz DEFAULT now()
);



Langkah 2: Buat Tabel profile
Ini adalah tabel utama untuk data pengguna. Perhatikan kolom user_id yang akan kita hubungkan ke auth.users di langkah berikutnya.
-- Tabel untuk menyimpan data publik pengguna
CREATE TABLE public.profile (
 id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  -- Ini akan dihubungkan ke auth.users.id
 user_id uuid NOT NULL UNIQUE,
  username text NOT NULL UNIQUE,
 full_name text NOT NULL,
 gender text CHECK (gender IN ('L', 'P')),
 birth_place text,
 birth_date date,
  -- Kolom untuk scope/data user
 -- Untuk user biasa ATAU admin_kelompok (scope mereka)
 group_id bigint REFERENCES public.group(id) ON DELETE SET NULL,
 -- Untuk user biasa
 class_id bigint REFERENCES public.class(id) ON DELETE SET NULL,
 -- KHUSUS untuk admin_desa (menentukan scope mereka)
 village_id bigint REFERENCES public.village(id) ON DELETE SET NULL,
 school_level text,
 school_name text,
 father_name text,
 father_occupation text,
 mother_name text,
 mother_occupation text,
 parent_contact text,
 role text NOT NULL DEFAULT “user”, 
  created_at timestamptz DEFAULT now(),
 updated_at timestamptz DEFAULT now()
);



Langkah 3: Atur Foreign Key & ON DELETE CASCADE (PENTING!)
Secara default, tabel profile Anda tidak akan terhapus jika Anda menghapus user dari auth.users. Ini akan menyebabkan data "yatim" (orphaned data).
Langkah ini memastikan jika Anda menghapus user di Auth, profile-nya akan terhapus secara otomatis. Ini akan membuat fungsi deleteUser Anda jauh lebih bersih.

ALTER TABLE public.profile
ADD CONSTRAINT fk_user_id
FOREIGN KEY (user_id)
REFERENCES auth.users(id)
ON DELETE CASCADE;

Langkah 4: Aktifkan Row Level Security (RLS)
Ini adalah langkah keamanan mendasar. Secara default, RLS mati. Kita harus menyalakannya untuk semua tabel yang berisi data sensitif atau data user.

ALTER TABLE public.profile ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.village ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.category ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.group ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.meeting_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.kbm_reports ENABLE ROW LEVEL SECURITY;

Langkah 5: Buat Kebijakan (Policies) RLS
Sekarang setelah semua tabel "terkunci", kita perlu membuat aturan (Policy) tentang siapa yang boleh mengakses apa.
Penting: Kebijakan ini hanya berlaku untuk koneksi level user (client.ts dan server-user.ts). Logika admin Anda di userService.ts menggunakan service_role dan akan melewati semua aturan ini, seperti yang kita inginkan.

-- KEBIJAKAN UNTUK DATA MASTER (Village, Class, Group)
-- Aturan: Siapapun yang sudah login (authenticated) boleh MEMBACA data master.
CREATE POLICY "Allow authenticated read access"
ON public.village FOR SELECT
TO authenticated
USING (true);


CREATE POLICY "Allow authenticated read access"
ON public.category FOR SELECT
TO authenticated
USING (true);


CREATE POLICY "Allow authenticated read access"
ON public.group FOR SELECT
TO authenticated
USING (true);


-- KEBIJAKAN UNTUK DATA PROFILE
-- Aturan 1: Pengguna bisa MEMBACA profil mereka sendiri.
CREATE POLICY "Allow user to read own profile"
ON public.profile FOR SELECT
TO authenticated
USING (auth.uid() = user_id); -- auth.uid() adalah ID user yang sedang login


-- Aturan 2: Pengguna bisa MEMPERBARUI profil mereka sendiri.
CREATE POLICY "Allow user to update own profile"
ON public.profile FOR UPDATE
TO authenticated
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);


-- CATATAN:
-- Kita TIDAK menambahkan policy untuk INSERT atau DELETE profile.
-- Ini disengaja!
-- Membuat (INSERT) dan Menghapus (DELETE) user harus ditangani
-- SECARA EKSKLUSIF oleh Server Action 'userService.ts' (createUser/deleteUser)
-- yang menggunakan service_role (Admin) agar tetap aman.



Setelah Anda menjalankan 5 langkah SQL ini, database Anda akan sepenuhnya siap dan selaras dengan semua file service dan types (.ts) yang telah kita buat.


Ini adalah pertanyaan yang sangat penting. Cara terbaik dan teraman untuk membuat "pengguna root" atau superadmin pertama adalah dengan melakukannya secara manual melalui Dashboard Supabase.
Ini adalah proses dua bagian:
Membuat User di layanan Authentication.
Membuat Data di tabel Database (profile) yang terhubung.
Berikut adalah panduan langkah demi langkahnya:
Bagian 1: Membuat User di "Authentication"
Buka proyek Supabase Anda dan pergi ke tab Authentication (ikon orang).
Klik tombol Add user.
Masukkan Email (misalnya, admin@project.com) dan Password yang aman untuk superadmin Anda.
PENTING: Aktifkan (toggle) "Auto-confirm user". Ini akan menandai email sebagai terverifikasi dan langsung mengaktifkan akunnya.
Klik Create user.

Bagian 3: Membuat Data di "Database" (profile)
Sekarang kita memiliki "akun" (Auth), tapi kita belum memiliki "data" (Profile).
Pergi ke tab Table Editor (ikon database).
Klik pada tabel profile Anda di sidebar.
Klik tombol Insert row di bagian atas.
Sebuah form akan muncul. Isi datanya:
user_id: WAJIB. Tempel (paste) User ID (UUID) yang Anda salin dari Bagian 2.
username: "superadmin" (atau apa pun yang Anda inginkan).
full_name: "Super Admin"
group_id: Biarkan kosong (null).
class_id: Biarkan kosong (null).
village_id: Biarkan kosong (null).
role: "superadmin"  (role di set manual superadmin)
(Kita biarkan group_id dan village_id kosong karena superadmin bersifat global. Logika di userService.ts kita sudah diatur untuk tidak memfilter apa pun jika role-nya superadmin).
Klik Save.
Selesai!
Itu saja. Anda sekarang memiliki satu pengguna di auth.users dengan role "superadmin", dan satu entri data di public.profile yang terhubung dengannya.
Anda sekarang dapat menggunakan email dan password dari Bagian 1 untuk login ke aplikasi Next.js Anda. Fungsi getAuthSession akan mendeteksi role: "superadmin" dan getUsersForAdmin akan memberi Anda akses penuh ke semua data pengguna.

Fitur Laporan KBM
Tambah fitur report: 
-- 1. Buat tabel kbm_reports
CREATE TABLE public.kbm_reports (
   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  
   -- Relasi
   group_id bigint NOT NULL REFERENCES public.group(id),
   village_id bigint NOT NULL REFERENCES public.village(id),  
   category_id bigint NOT NULL REFERENCES public.category(id),
   author_user_id UUID NOT NULL REFERENCES auth.users(id),
  
   -- Info Laporan
   period_month INT NOT NULL,
   period_year INT NOT NULL,
  
   -- 1. Info Jumlah Generus
   count_male INT DEFAULT 0,
   count_female INT DEFAULT 0,
   count_total INT DEFAULT 0,
  
   -- 2. Info Presentase Kehadiran
   attendance_total_students INT DEFAULT 0,
   attendance_present_percentage REAL DEFAULT 0, -- Gunakan REAL untuk persentase (cth: 80.5)
   attendance_permission_percentage REAL DEFAULT 0,
   attendance_absent_percentage REAL DEFAULT 0,
  
   -- 3. Info Capaian Materi
   achievement_quran_meaning TEXT,
   achievement_hadith_meaning TEXT,
   achievement_quran_reading TEXT,
   achievement_surah_memorization TEXT,
   achievement_dalil_memorization TEXT,
   achievement_prayer_memorization TEXT,
   achievement_tajwid TEXT,
   achievement_character TEXT,
  
   -- 4. Info Keberhasilan Program
   program_success_info TEXT,
  
   -- 5. Info Tantangan/Kendala
   challenges_info TEXT,
  
   -- Check constraint untuk bulan
   CONSTRAINT month_check CHECK (period_month >= 1 AND period_month <= 12)
);




-- 2. Aktifkan RLS (Row Level Security)
ALTER TABLE public.kbm_reports ENABLE ROW LEVEL SECURITY;

-- 3. Buat Aturan RLS
-- Aturan 1: Admin Desa bisa melihat/membuat laporan di desanya
CREATE POLICY "Admin Desa can manage reports in their village"
ON public.kbm_reports
FOR ALL
USING (
  auth.uid() IN (
    SELECT user_id FROM public.profile 
    WHERE role = 'admin_desa' AND village_id = public.kbm_reports.village_id
  )
)
WITH CHECK (
  auth.uid() IN (
    SELECT user_id FROM public.profile 
    WHERE role = 'admin_desa' AND village_id = public.kbm_reports.village_id
  )
);

-- Aturan 2: Superadmin bisa melakukan apa saja
CREATE POLICY "Superadmin full access"
ON public.kbm_reports
FOR ALL
USING (
  auth.uid() IN (SELECT user_id FROM public.profile WHERE role = 'superadmin')
)
WITH CHECK (
  auth.uid() IN (SELECT user_id FROM public.profile WHERE role = 'superadmin')
);

-- Policy 3: Izinkan 'admin_kelompok' mengelola laporan HANYA
-- untuk kelompok mereka sendiri.


CREATE POLICY "Admin Kelompok can manage reports for their group"
ON public.kbm_reports
FOR ALL
-- 'USING' berlaku untuk SELECT, UPDATE, DELETE (Membaca/Mengubah data yg ada)
-- Pengguna bisa melihat/mengubah/menghapus laporan JIKA group_id laporan
-- SAMA DENGAN group_id milik admin_kelompok tersebut.
USING (
 auth.uid() IN (
   SELECT user_id FROM public.profile
   WHERE role = 'admin_kelompok' AND group_id = public.kbm_reports.group_id
 )
)
-- 'WITH CHECK' berlaku untuk INSERT, UPDATE (Memasukkan data baru)
-- Pengguna HANYA bisa memasukkan/memperbarui laporan JIKA group_id laporan
-- SAMA DENGAN group_id milik admin_kelompok tersebut.
WITH CHECK (
 auth.uid() IN (
   SELECT user_id FROM public.profile
   WHERE role = 'admin_kelompok' AND group_id = public.kbm_reports.group_id
 )
);


/* SQL untuk tabel Laporan Musyawarah 5 Unsur */
CREATE TABLE meeting_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMPTZ DEFAULT now(),
  author_user_id UUID REFERENCES auth.users(id),
  group_id UUID REFERENCES groups(id),        -- Kelompok yg musyawarah
  village_id UUID REFERENCES villages(id),    -- Desa dari kelompok
  period_month INT NOT NULL,
  period_year INT NOT NULL,
  muroh_date DATE NOT NULL,                   -- Tgl Musyawarah
  muroh_place TEXT,
  
  /* 5 Unsur yang Hadir */
  element_ki TEXT,                            -- cth: "Bpk Kusnadi"
  element_management TEXT,                    -- cth: "Bpk H. Adimin"
  element_expert TEXT,                        -- cth: "Bpk Kusnadi"
  element_mubaligh TEXT,                      -- cth: "Mas Mario, Teh Nanda"
  element_parent TEXT,                        -- cth: "Orangtua Generus"
  
  /* Catatan Global (Level Kelompok) */
  muroh_notes TEXT,                           -- Catatan umum musyawarah
  rundown TEXT
);

ALTER TABLE kbm_reports ADD COLUMN five_element_report_id UUID REFERENCES five_element_reports(id) ON DELETE SET NULL;   

CREATE OR REPLACE FUNCTION get_muslimun_periods(
    v_id bigint  -- <-- PERUBAHAN DI SINI (dari text menjadi bigint)
)
RETURNS TABLE (
    period_year integer,
    period_month integer,
    report_count bigint
)
LANGUAGE sql
AS $$
SELECT
    period_year,
    period_month,
    COUNT(id) AS report_count
FROM
    public.meeting_reports
WHERE
    village_id = v_id  -- <-- Sekarang ini membandingkan bigint = bigint
GROUP BY
    period_year, period_month
ORDER BY
    period_year DESC,
    period_month DESC;
$$;


Untuk keperluan dashboard: 
/**
* Fungsi ini mengambil total generus (role='user')
* dikelompokkan berdasarkan kategori dan gender.
* Untuk Superadmin.
*/
CREATE OR REPLACE FUNCTION get_global_user_stats_by_category_gender()
RETURNS TABLE(category_name TEXT, gender TEXT, total_users BIGINT) AS $$
BEGIN
 RETURN QUERY
   SELECT
     COALESCE(c.name, 'Tanpa Kategori') AS category_name,
     COALESCE(p.gender, 'N/A') AS gender,
     COUNT(p.id) AS total_users
   FROM
     profile p
   LEFT JOIN
     category c ON p.category_id::BIGINT = c.id
   GROUP BY
     c.name, p.gender
   ORDER BY
     category_name, gender;
END;
$$ LANGUAGE plpgsql;


/**
* Fungsi ini mengambil total generus (role='user')
* UNTUK SATU DESA,
* dikelompokkan berdasarkan kelompok, kategori, dan gender.
* Untuk Admin Desa.
*/
CREATE OR REPLACE FUNCTION get_village_user_stats_by_group_category_gender(p_village_id BIGINT)
RETURNS TABLE(group_name TEXT, category_name TEXT, gender TEXT, total_users BIGINT) AS $$
BEGIN
 RETURN QUERY
   SELECT
     COALESCE(g.name, 'Tanpa Kelompok') AS group_name,
     COALESCE(c.name, 'Tanpa Kategori') AS category_name,
     COALESCE(p.gender, 'N/A') AS gender,
     COUNT(p.id) AS total_users
   FROM
     profile p
   LEFT JOIN
     "group" g ON p.group_id::BIGINT = g.id
   LEFT JOIN
     category c ON p.category_id::BIGINT = c.id
   WHERE
     p.role = 'user'
     AND p.village_id::BIGINT = p_village_id
   GROUP BY
     g.name, c.name, p.gender
   ORDER BY
     group_name, category_name, gender;
END;
$$ LANGUAGE plpgsql;

Ralat kode di atas:
/**
* Fungsi ini mengambil total generus (role='user')
* UNTUK SATU DESA,
* dikelompokkan berdasarkan kelompok, kategori, dan gender.
* Untuk Admin Desa.
*/
DROP FUNCTION IF EXISTS get_village_user_stats_by_group_category_gender(bigint);
CREATE OR REPLACE FUNCTION get_village_user_stats_by_group_category_gender(p_village_id BIGINT)
RETURNS TABLE(
 group_id BIGINT, -- [DITAMBAHKAN]
 group_name TEXT,
 category_name TEXT,
 gender TEXT,
 total_users BIGINT
) AS $$
BEGIN
 RETURN QUERY
   SELECT
     g.id AS group_id, -- [DITAMBAHKAN]
     COALESCE(g.name, 'Tanpa Kelompok') AS group_name,
     COALESCE(c.name, 'Tanpa Kategori') AS category_name,
     COALESCE(p.gender, 'N/A') AS gender,
     COUNT(p.id) AS total_users
   FROM
     profile p
   LEFT JOIN
     "group" g ON p.group_id::BIGINT = g.id
   LEFT JOIN
     category c ON p.category_id::BIGINT = c.id
   WHERE
     p.role = 'user'
     AND p.village_id::BIGINT = p_village_id
   GROUP BY
     g.id, g.name, c.name, p.gender -- [DITAMBAHKAN] g.id
   ORDER BY
     group_name, category_name, gender;
END;
$$ LANGUAGE plpgsql;


#### Untuk fitur dokumen
/* 1. Buat tabel untuk menyimpan metadata berkas */
CREATE TABLE public.documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMPTZ DEFAULT now(),
  author_user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  
  title TEXT NOT NULL,
  description TEXT,
  
  /* Tipe berkas: 'FILE' atau 'LINK' */
  document_type TEXT NOT NULL,
  
  /* Opsional: Untuk scoping */
  village_id BIGINT REFERENCES public.village(id) ON DELETE SET NULL,
  group_id BIGINT REFERENCES public.group(id) ON DELETE SET NULL,
  
  /* Hanya diisi jika document_type = 'FILE' */
  file_path TEXT,      -- Path di Supabase Storage
  file_type TEXT,      -- cth: 'application/pdf'
  file_size BIGINT,    -- Ukuran dalam bytes
  
  /* Hanya diisi jika document_type = 'LINK' */
  external_url TEXT
);

/* 2. Aktifkan Row Level Security (RLS) pada tabel */
ALTER TABLE public.documents ENABLE ROW LEVEL SECURITY;

/* 3. Buat Policies untuk tabel documents */
/* Siapapun yang terotentikasi bisa melihat semua berkas */
CREATE POLICY "Allow authenticated read access"
ON public.documents
FOR SELECT USING (auth.role() = 'authenticated');

/* Hanya pembuat berkas atau admin yang bisa menambah/mengedit/menghapus */
CREATE POLICY "Allow insert for authenticated users"
ON public.documents
FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Allow update by owner or admin"
ON public.documents
FOR UPDATE USING (
  auth.uid() = author_user_id OR 
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'superadmin' OR
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_desa'
) WITH CHECK (
  auth.uid() = author_user_id OR 
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'superadmin' OR
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_desa'
);

CREATE POLICY "Allow delete by owner or admin"
ON public.documents
FOR DELETE USING (
  auth.uid() = author_user_id OR 
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'superadmin' OR
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_desa'
);


/* --- KONFIGURASI SUPABASE STORAGE --- */

/* 1. Buat Storage Bucket bernama 'documents' */
/* Anda BISA juga melakukan ini via UI Supabase */
INSERT INTO storage.buckets (id, name, public)
VALUES ('documents', 'documents', FALSE)
ON CONFLICT (id) DO NOTHING;

/* 2. Buat Policy untuk Storage (PENTING!) */
/* Izinkan pengguna terotentikasi mengunggah ke folder 'public' */
CREATE POLICY "Allow authenticated uploads"
ON storage.objects
FOR INSERT TO authenticated
WITH CHECK (
  bucket_id = 'documents' 
  AND (storage.foldername(name))[1] = 'public'
);

/* Izinkan pengguna terotentikasi membaca file dari folder 'public' */
CREATE POLICY "Allow authenticated reads"
ON storage.objects
FOR SELECT TO authenticated
USING (
  bucket_id = 'documents' 
  AND (storage.foldername(name))[1] = 'public'
);

/* Izinkan pembuat file menghapus filenya */
CREATE POLICY "Allow owner delete"
ON storage.objects
FOR DELETE TO authenticated
USING (
  bucket_id = 'documents' 
  AND owner = auth.uid()
);


Terjadi: Error fetching documents list: Could not find a relationship between 'documents' and 'profile' in the schema cache
SOlusi:
-- 1. Hapus foreign key lama yang mengarah ke auth.users
ALTER TABLE public.documents
DROP CONSTRAINT documents_author_user_id_fkey; 
-- Catatan: Nama constraint mungkin berbeda, cek di menu Table Editor jika gagal. 
-- Biasanya formatnya: namatabel_namakolom_fkey

-- 2. Buat foreign key baru yang mengarah ke public.profile(user_id)
ALTER TABLE public.documents
ADD CONSTRAINT fk_documents_author_profile
FOREIGN KEY (author_user_id)
REFERENCES public.profile(user_id)
ON DELETE SET NULL;

--> perbaiki juga getDocumentsList (sudah)


##### Fitur Materi dan kategori Materi
/* --- 1. TABEL KATEGORI MATERI (MASTER DATA) --- */
CREATE TABLE public.material_category (
  id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
  name TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

/* Aktifkan RLS */
ALTER TABLE public.material_category ENABLE ROW LEVEL SECURITY;

/* Policies untuk Kategori Materi */
CREATE POLICY "Allow authenticated read access"
ON public.material_category
FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Allow admin CUD access"
ON public.material_category
FOR ALL USING (
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'superadmin' OR
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_desa'
) WITH CHECK (
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'superadmin' OR
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_desa'
);


/* --- 2. TABEL MATERI (FITUR UTAMA) --- */
CREATE TABLE public.material (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMPTZ DEFAULT now(),
  author_user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  
  material_name TEXT NOT NULL,
  description TEXT,
  evaluation TEXT, -- (Penilaian / Evaluasi)
  
  /* Relasi ke Kategori */
  material_category_id BIGINT REFERENCES public.material_category(id) ON DELETE SET NULL
);

/* Aktifkan RLS */
ALTER TABLE public.material ENABLE ROW LEVEL SECURITY;

/* Policies untuk Materi */
CREATE POLICY "Allow authenticated read access"
ON public.material
FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Allow admin CUD access"
ON public.material
FOR ALL USING (
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'superadmin' OR
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_desa'
) WITH CHECK (
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'superadmin' OR
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_desa'
);

ALTER TABLE public.material
ADD CONSTRAINT fk_material_author_profile
FOREIGN KEY (author_user_id)
REFERENCES public.profile(user_id)
ON DELETE SET NULL;


/****************************
* ATTENDANCE REPORT MODULE
*****************************/

/* --- 1. TABEL REKAP PRESENSI --- */
CREATE TABLE public.attendance_recap (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMPTZ DEFAULT now(),
  author_user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  
  group_id BIGINT NOT NULL REFERENCES public.group(id),
  village_id BIGINT NOT NULL REFERENCES public.village(id),  
  category_id BIGINT NOT NULL REFERENCES public.category(id),
  
  period_month INT NOT NULL,
  period_year INT NOT NULL,
  
  /* Data mentah dari form input per siswa */
  /* Contoh: 
    {
      "user-uuid-1": { "p": 10, "i": 2, "a": 0 },
      "user-uuid-2": { "p": 12, "i": 0, "a": 0 }
    }
  */
  raw_data JSONB NOT NULL,
  
  /* Data yang Dikalkulasi (Rekapitulasi) */
  meeting_count INT NOT NULL,           -- Total pertemuan
  generus_count INT NOT NULL,           -- Total generus di kelas itu
  
  present_amount INT NOT NULL,
  present_percentage FLOAT NOT NULL,
  
  permission_amount INT NOT NULL,
  permission_percentage FLOAT NOT NULL,
  
  absent_amount INT NOT NULL,
  absent_percentage FLOAT NOT NULL,

  notes TEXT NULL
);

/* Aktifkan RLS */
ALTER TABLE public.attendance_recap ENABLE ROW LEVEL SECURITY;

/* Policies untuk Rekap Presensi */
CREATE POLICY "Allow authenticated read access"
ON public.attendance_recap
FOR SELECT USING (auth.role() = 'authenticated');

/* Hanya admin desa & kelompok yang bisa CUD */
CREATE POLICY "Allow admin CUD access"
ON public.attendance_recap
FOR ALL USING (
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_desa' OR
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_kelompok'
) WITH CHECK (
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_desa' OR
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_kelompok'
);

ALTER TABLE public.attendance_recap
ADD CONSTRAINT fk_attendance_author_profile
FOREIGN KEY (author_user_id)
REFERENCES public.profile(user_id)
ON DELETE SET NULL;

/****************************
* STUDENT EVALUATION REPORT MODULE
*****************************/

/* --- 1. TABEL REKAP PENILAIAN --- */
CREATE TABLE public.evaluation_recap (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMPTZ DEFAULT now(),
  author_user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  
  group_id BIGINT NOT NULL REFERENCES public.group(id),
  village_id BIGINT NOT NULL REFERENCES public.village(id),  
  category_id BIGINT NOT NULL REFERENCES public.category(id),
  
  period_month INT NOT NULL,
  period_year INT NOT NULL,
  
  /* Catatan umum untuk rekap ini */
  notes TEXT,      -- Catatan Tambahan
  
  /* Data mentah dari form input per siswa per materi
    Struktur: { "material_id_1": { "user_id_1": "A", "user_id_2": "B" }, ... }
  */
  raw_data JSONB NOT NULL
);

/* Aktifkan RLS */
ALTER TABLE public.evaluation_recap ENABLE ROW LEVEL SECURITY;

/* Policies untuk Rekap Penilaian */
CREATE POLICY "Allow authenticated read access"
ON public.evaluation_recap
FOR SELECT USING (auth.role() = 'authenticated');

/* Hanya admin desa & kelompok yang bisa CUD */
CREATE POLICY "Allow admin CUD access"
ON public.evaluation_recap
FOR ALL USING (
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_desa' OR
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_kelompok'
) WITH CHECK (
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_desa' OR
  (SELECT role FROM public.profile WHERE user_id = auth.uid()) = 'admin_kelompok'
);

ALTER TABLE public.evaluation_recap
ADD CONSTRAINT fk_evaluation_author_profile
FOREIGN KEY (author_user_id)
REFERENCES public.profile(user_id)
ON DELETE SET NULL;

## Penyesuaian table report : 
menghilangkan achievement_*, diganti dengan raw_data

/* Hapus kolom-kolom lama */
ALTER TABLE public.kbm_reports 
DROP COLUMN IF EXISTS achievement_quran_meaning,
DROP COLUMN IF EXISTS achievement_hadith_meaning,
DROP COLUMN IF EXISTS achievement_quran_reading,
DROP COLUMN IF EXISTS achievement_writing,
DROP COLUMN IF EXISTS achievement_surah_memorization,
DROP COLUMN IF EXISTS achievement_dalil_memorization,
DROP COLUMN IF EXISTS achievement_prayer_memorization,
DROP COLUMN IF EXISTS achievement_asmaul_husna,
DROP COLUMN IF EXISTS achievement_tajwid,
DROP COLUMN IF EXISTS achievement_practices,
DROP COLUMN IF EXISTS achievement_character;

/* Tambahkan kolom raw_data */
/* Struktur: { "material_id": "Catatan pencapaian..." } */
ALTER TABLE public.kbm_reports 
ADD COLUMN IF NOT EXISTS raw_data JSONB DEFAULT '{}'::jsonb;


/***********************************************************************/

/* -------------------------------------------------------------------------
   POLICY 1: SELECT (Membaca Data)
   Izinkan semua user yang sudah login (authenticated) untuk melihat laporan.
   (Anda bisa membatasinya lebih ketat jika perlu, misal hanya melihat desa sendiri)
------------------------------------------------------------------------- */
DROP POLICY IF EXISTS "Enable read access for authenticated users" ON public.meeting_reports;

CREATE POLICY "Enable read access for authenticated users"
ON public.meeting_reports FOR SELECT
TO authenticated
USING (true);

/* -------------------------------------------------------------------------
   POLICY 2: INSERT (Menambah Data)
   - Admin Desa boleh insert jika village_id di laporan = village_id di profilnya.
   - Admin Kelompok boleh insert jika group_id di laporan = group_id di profilnya.
------------------------------------------------------------------------- */
DROP POLICY IF EXISTS "Enable insert for admins" ON public.meeting_reports;

CREATE POLICY "Enable insert for admins"
ON public.meeting_reports FOR INSERT
TO authenticated
WITH CHECK (
  EXISTS (
    SELECT 1 FROM public.profile
    WHERE profile.user_id = auth.uid()
    AND (
      -- Aturan untuk Admin Desa
      (profile.role = 'admin_desa' AND profile.village_id = meeting_reports.village_id) 
      OR
      -- Aturan untuk Admin Kelompok
      (profile.role = 'admin_kelompok' AND profile.group_id = meeting_reports.group_id)
    )
  )
);

/* -------------------------------------------------------------------------
   POLICY 3: UPDATE (Mengedit Data)
   Sama seperti insert, pastikan mereka hanya mengedit wilayah wewenangnya.
------------------------------------------------------------------------- */
DROP POLICY IF EXISTS "Enable update for admins" ON public.meeting_reports;

CREATE POLICY "Enable update for admins"
ON public.meeting_reports FOR UPDATE
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.profile
    WHERE profile.user_id = auth.uid()
    AND (
      (profile.role = 'admin_desa' AND profile.village_id = meeting_reports.village_id) OR
      (profile.role = 'admin_kelompok' AND profile.group_id = meeting_reports.group_id)
    )
  )
)
WITH CHECK (
  EXISTS (
    SELECT 1 FROM public.profile
    WHERE profile.user_id = auth.uid()
    AND (
      (profile.role = 'admin_desa' AND profile.village_id = meeting_reports.village_id) OR
      (profile.role = 'admin_kelompok' AND profile.group_id = meeting_reports.group_id)
    )
  )
);

/* -------------------------------------------------------------------------
   POLICY 4: DELETE (Menghapus Data)
------------------------------------------------------------------------- */
DROP POLICY IF EXISTS "Enable delete for admins" ON public.meeting_reports;

CREATE POLICY "Enable delete for admins"
ON public.meeting_reports FOR DELETE
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.profile
    WHERE profile.user_id = auth.uid()
    AND (
      (profile.role = 'admin_desa' AND profile.village_id = meeting_reports.village_id) OR
      (profile.role = 'admin_kelompok' AND profile.group_id = meeting_reports.group_id)
    )
  )
);